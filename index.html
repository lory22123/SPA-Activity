<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026å¹´é”è± & æ˜å®š æ˜¥é…’æ´»å‹•</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --app-height: 100dvh; }
        body {
            height: var(--app-height);
            margin: 0;
            background-color: #b91c1c;
            overflow: hidden;
            touch-action: manipulation;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-12px) rotate(2deg); }
        }
        .animate-float { animation: float 5s ease-in-out infinite; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .text-shadow-lg { text-shadow: 0 4px 8px rgba(0,0,0,0.5); }
        .quiz-card {
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="text-white font-sans selection:bg-yellow-400">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyCuhIpxtvxVux4JhMKvF89JTvs7-MiKK6Q",
            authDomain: "spa-activity.firebaseapp.com",
            projectId: "spa-activity",
            storageBucket: "spa-activity.firebasestorage.app",
            messagingSenderId: "8554093402",
            appId: "1:8554093402:web:f21469855b0f24eda4f163",
            measurementId: "G-7NVTFPQGR0"
        };

        const appId = 'spa-activity-stable-v10'; 

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const Icon = ({ name, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && typeof lucide !== 'undefined') {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`;
                    lucide.createIcons({ root: containerRef.current });
                }
            }, [name, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center shrink-0"></span>;
        };

        const QUESTIONS = [
            { q: "2026 å¹´æ˜¯å¤©å¹²åœ°æ”¯ä¸­çš„ä»€éº¼å¹´ï¼Ÿ", a: ["ç”²è¾°", "è¾›ä¸‘", "ç™¸å·³", "ä¸™åˆ"], correct: 3 },
            { q: "æˆèªã€Œé¦¬åˆ°æˆåŠŸã€é€šå¸¸ç”¨ä¾†ç¥è³€ä»€éº¼ï¼Ÿ", a: ["èº«é«”å¥åº·", "äº‹æƒ…é †åˆ©åœ“æ»¿", "æ—©ç”Ÿè²´å­", "ä¸­å¤§ç"], correct: 1 },
            { q: "æ˜¥ç¯€å‚³çµ±ä¸­ï¼Œåˆå¹¾æ˜¯ã€Œé–‹å·¥æ—¥ã€ï¼Ÿ", a: ["åˆä¸€", "åˆä¸‰", "åˆäº”", "åˆä¸ƒ"], correct: 2 },
            { q: "ä¸‹åˆ—å“ªä¸€å€‹ä¸æ˜¯éå¹´å¸¸åƒçš„å‰ç¥¥é£Ÿç‰©ï¼Ÿ", a: ["é•·å¹´èœ", "ç™¼ç³•", "è¥¿ç“œ", "æ°´é¤ƒ"], correct: 2 },
            { q: "å½¢å®¹äººç²¾ç¥æŠ–æ“»ã€æ„æ°£é¢¨ç™¼çš„æˆèªæ˜¯ï¼Ÿ", a: ["è€é¦¬è­˜é€”", "é¾é¦¬ç²¾ç¥", "æŒ‡é¹¿ç‚ºé¦¬", "é¦¬é¦–æ˜¯ç»"], correct: 1 },
            { q: "ç´…åŒ…é€šå¸¸åˆè¢«ç¨±ç‚ºï¼Ÿ", a: ["å£“æ­²éŒ¢", "éå¹´éŒ¢", "å–œé…’éŒ¢", "é•·å£½éŒ¢"], correct: 0 },
            { q: "å€’è²¼ã€Œç¦ã€å­—ä»£è¡¨ä»€éº¼æ„æ€ï¼Ÿ", a: ["ç¦æ°£æ²’äº†", "ç¦æ°£åˆ°", "ç¦æ°£å¤š", "ç¦æ°£æ»¿"], correct: 1 },
            { q: "é™¤å¤•å¤œå…¨å®¶äººèšåœ¨ä¸€èµ·åƒçš„é£¯å«ï¼Ÿ", a: ["æ—©é½‹", "åœçˆ", "æ»¿æ¼¢å…¨å¸­", "è¬å¸«å®´"], correct: 1 },
            { q: "å“ªç¨®æ°´æœè±¡å¾µã€Œå¤§å‰å¤§åˆ©ã€ï¼Ÿ", a: ["è˜‹æœ", "æ©˜å­", "é¦™è•‰", "è¥¿ç“œ"], correct: 1 },
            { q: "æœ¬æ¬¡æ´»å‹•çš„å…¨ç¨±æ˜¯ï¼Ÿ", a: ["2026å¹´é”è± & æ˜å®š æ˜¥é…’æ´»å‹•", "2026 é”è±æ˜¥ç¯€æ™šæœƒ", "æ˜å®šé¦¬åˆ°æˆåŠŸå¤§æœƒ", "æ˜å®šèˆ‡é”è± èšé¤"], correct: 0 }
        ];

        const SPONSORS = [
            { name: "èŒ‚ç¢©é€šé‹è‚¡ä»½æœ‰é™å…¬å¸", prize: "ç¾é‡‘ 5,000å…ƒ" },
            { name: "å®‡å®™è¯é‹ä¼æ¥­æœ‰é™å…¬å¸", prize: "ç¾é‡‘ 3,000å…ƒ" },
            { name: "ç…å¨èˆªç©ºè²¨é‹æ‰¿æ”¬è‚¡ä»½æœ‰é™å…¬å¸", prize: "å…¨è¯ç¦®åˆ¸ 2,000å…ƒ" },
            { name: "ä¿¡å…¨é‹é€šæœ‰é™å…¬å¸", prize: "å…¨è¯ç¦®åˆ¸ 1,000å…ƒ" }
        ];

        const INITIAL_PRIZES = ["8888å…ƒ", "6666å…ƒ", "3600å…ƒ", "2000å…ƒ", "1200å…ƒ", "600å…ƒ", "é¦¬å¹´é‡‘å¹£", "åŠ ç¢¼ç", "é©šå–œç¦®åŒ…"];

        // --- ç¥è³€ç‰†æ–‡å­—é›² ---
        const WordCloud = ({ words, isBackground = false }) => {
            const slots = [
                { t: 10, l: 15, rot: -4 }, { t: 25, l: 55, rot: 6 }, { t: 40, l: 10, rot: -8 },
                { t: 55, l: 65, rot: 4 }, { t: 65, l: 15, rot: 10 }, { t: 78, l: 50, rot: -4 },
                { t: 88, l: 20, rot: 8 }, { t: 45, l: 75, rot: -10 }, { t: 5, l: 45, rot: 5 }
            ];
            return (
                <div className={`transition-all duration-1000 ${isBackground ? 'absolute inset-0 z-0 opacity-40 pointer-events-none' : 'relative w-full flex-grow min-h-[350px] bg-red-900/40 rounded-3xl border-2 border-yellow-500/20 shadow-inner overflow-hidden flex flex-col items-center justify-center'}`}>
                    <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none text-[150px]">ğŸ</div>
                    {words.length > 0 ? (
                        words.slice(0, 9).map((w, idx) => {
                            const slot = slots[idx % slots.length];
                            const colors = ['text-yellow-400', 'text-white', 'text-orange-200', 'text-yellow-100'];
                            return (
                                <div key={w.id || idx} className={`absolute animate-float font-black text-center drop-shadow-xl transition-all duration-1000`}
                                    style={{ 
                                        top: `${slot.t}%`, 
                                        left: `${slot.l}%`, 
                                        transform: `rotate(${slot.rot}deg)`, 
                                        color: colors[idx % colors.length], 
                                        fontSize: isBackground ? `${Math.max(18, 36 - (w.greeting || '').length * 2)}px` : `${Math.max(22, 44 - (w.greeting || '').length * 2)}px`
                                    }}>
                                    <div>{w.greeting}</div>
                                    <div className="text-[10px] opacity-60 font-bold mt-1">-{w.name}</div>
                                </div>
                            );
                        })
                    ) : (
                        !isBackground && <div className="text-center space-y-4 animate-pulse opacity-30"><Icon name="loader-2" className="w-12 h-12 mx-auto animate-spin" /><p className="italic font-bold">ç­‰å¾…åŒä»åŠ å…¥ä¸­...</p></div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [gameStep, setGameStep] = useState('register'); 
            const [players, setPlayers] = useState([]);
            const [gameState, setGameState] = useState({ countdownStartTime: 0, prizesPool: INITIAL_PRIZES });
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [score, setScore] = useState(0);
            const [totalTime, setTotalTime] = useState(0);
            const [quizStartTime, setQuizStartTime] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [localCountdown, setLocalCountdown] = useState(null);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    if (u) setUser(u); else auth.signInAnonymously();
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubPlayers = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players')
                    .onSnapshot(s => setPlayers(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubState = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('gameState')
                    .onSnapshot(s => {
                        if (s.exists) setGameState(s.data());
                        else if (isAdmin) db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('gameState').set({ countdownStartTime: 0, prizesPool: INITIAL_PRIZES });
                    });
                return () => { unsubPlayers(); unsubState(); };
            }, [user, isAdmin]);

            useEffect(() => {
                const isRecent = gameState.countdownStartTime > (Date.now() - 60000);
                if (gameState.countdownStartTime > 0 && isRecent && gameStep === 'greetings') {
                    const timer = setInterval(() => {
                        const diff = Math.max(0, 5 - Math.floor((Date.now() - gameState.countdownStartTime) / 1000));
                        setLocalCountdown(diff);
                        if (diff <= 0) { clearInterval(timer); setTimeout(() => { setGameStep('quiz'); setQuizStartTime(Date.now()); }, 800); }
                    }, 100);
                    return () => clearInterval(timer);
                }
            }, [gameState.countdownStartTime, gameStep]);

            const sortedPlayers = useMemo(() => {
                return [...players].sort((a, b) => (b.score - a.score) || (a.totalTime - b.totalTime));
            }, [players]);

            const me = useMemo(() => sortedPlayers.find(p => p.id === user?.uid), [sortedPlayers, user]);
            const myRank = useMemo(() => sortedPlayers.findIndex(p => p.id === user?.uid) + 1, [sortedPlayers, user]);
            const others = useMemo(() => sortedPlayers.filter(p => p.id !== user?.uid), [sortedPlayers, user]);

            const handleRegister = async (e) => {
                e.preventDefault();
                const name = e.target.name.value;
                const greeting = e.target.greeting.value;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players').doc(user.uid).set({
                    name, greeting: greeting.substring(0, 10), score: 0, totalTime: 0, prize: '', timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                setGameStep('sponsors');
            };

            const confirmAnswer = async () => {
                if (selectedOption === null) return;
                const isCorrect = selectedOption === QUESTIONS[currentQuestionIndex].correct;
                const newScore = isCorrect ? score + 100 : score;
                const newTotalTime = totalTime + (Date.now() - quizStartTime);
                if (currentQuestionIndex < QUESTIONS.length - 1) {
                    setScore(newScore); setTotalTime(newTotalTime); setCurrentQuestionIndex(prev => prev + 1); setSelectedOption(null); setQuizStartTime(Date.now());
                } else {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players').doc(user.uid).update({ score: newScore, totalTime: newTotalTime });
                    setGameStep('leaderboard');
                }
            };

            return (
                <div className="flex flex-col h-full bg-red-700 max-w-lg mx-auto shadow-2xl relative overflow-hidden text-white">
                    <div className="p-4 flex justify-between items-center bg-red-800/95 border-b border-yellow-600/30 shrink-0 z-20 shadow-md">
                        <h1 className="text-lg font-black flex items-center gap-2 tracking-tighter"><span className="text-xl animate-bounce">ğŸ</span> 2026å¹´é”è± & æ˜å®š æ˜¥é…’æ´»å‹•</h1>
                        <button onClick={() => setIsAdmin(!isAdmin)} className="text-[10px] bg-yellow-600/50 px-3 py-1 rounded-full border border-yellow-400/50 font-bold uppercase">{isAdmin ? 'User' : 'Admin'}</button>
                    </div>

                    <div className="flex-grow flex flex-col overflow-y-auto no-scrollbar relative p-4">
                        {isAdmin ? (
                            <AdminView players={players} appId={appId} gameState={gameState} PRIZES={INITIAL_PRIZES} sortedPlayers={sortedPlayers} />
                        ) : (
                            <div className="flex-grow flex flex-col h-full relative">
                                {gameStep === 'register' && (
                                    <div className="my-auto space-y-8 animate-in fade-in zoom-in duration-500 z-10">
                                        <div className="text-center">
                                            <div className="bg-yellow-500 w-24 h-24 rounded-full flex items-center justify-center mx-auto border-4 border-red-900 shadow-2xl mb-4 animate-bounce"><Icon name="sparkles" className="text-red-800 w-12 h-12" /></div>
                                            <h2 className="text-3xl font-black text-yellow-400 tracking-widest text-shadow-lg">é¦¬åˆ°æˆåŠŸ 2026</h2>
                                        </div>
                                        <form onSubmit={handleRegister} className="space-y-4 px-4">
                                            <input name="name" required className="w-full p-4 rounded-2xl bg-red-900 border-2 border-yellow-600 focus:border-yellow-400 outline-none text-xl shadow-inner" placeholder="æ‚¨çš„å§“å" />
                                            <input name="greeting" required maxLength={10} className="w-full p-4 rounded-2xl bg-red-900 border-2 border-yellow-600 focus:border-yellow-400 outline-none text-xl shadow-inner" placeholder="é¦¬å¹´è³€è© (é™10å­—)" />
                                            <button type="submit" className="w-full py-5 bg-yellow-500 text-red-900 font-black rounded-2xl shadow-xl text-2xl border-b-4 border-yellow-700 active:translate-y-1">é ˜å–åƒè³½è­‰ ğŸ</button>
                                        </form>
                                    </div>
                                )}

                                {gameStep === 'sponsors' && (
                                    <div className="flex-grow flex flex-col h-full space-y-6 animate-in slide-in-from-right duration-500 z-10 text-center">
                                        <h2 className="text-2xl font-black text-yellow-400 mt-4 tracking-wider">æ„Ÿè¬è´ŠåŠ©å•†æ”¯æŒ</h2>
                                        <div className="flex-grow space-y-3 overflow-y-auto no-scrollbar pb-4">
                                            {SPONSORS.map((s, i) => (
                                                <div key={i} className="bg-red-800 p-4 rounded-2xl border border-yellow-600/30 flex items-center gap-4 shadow-md group text-left">
                                                    <div className="bg-yellow-50/10 p-2 rounded-lg text-yellow-400"><Icon name="gift" className="w-6 h-6" /></div>
                                                    <div><div className="font-black text-lg text-yellow-50">{s.name}</div><div className="text-sm text-yellow-200/80">{s.prize}</div></div>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={() => setGameStep('greetings')} className="w-full py-5 bg-yellow-500 text-red-900 font-black rounded-2xl shadow-xl text-xl border-b-4 border-yellow-700 shrink-0 mb-4 font-bold">é€²å…¥æº–å‚™ <Icon name="chevron-right" className="inline w-6 h-6" /></button>
                                    </div>
                                )}

                                {gameStep === 'greetings' && (
                                    <div className="flex-grow flex flex-col space-y-4 animate-in fade-in h-full z-10">
                                        <div className="text-center shrink-0">
                                            <Icon name="megaphone" className="mx-auto text-yellow-400 mb-1 w-8 h-8 animate-pulse" />
                                            <h2 className="text-2xl font-black text-yellow-400">åŒä»é¦¬å¹´ç¥è³€ç‰†</h2>
                                        </div>
                                        <WordCloud words={players} />
                                        <div className="text-center text-xs text-yellow-400/60 animate-pulse font-bold bg-red-900/30 py-3 rounded-full">ğŸ’¡ è«‹ç­‰å€™ä¸»è¾¦æ–¹æŒ‰ä¸‹å•Ÿå‹•å€’æ•¸...</div>
                                        {localCountdown !== null && (
                                            <div className="fixed inset-0 z-50 bg-red-900/98 flex flex-col items-center justify-center animate-in fade-in">
                                                <div className="text-yellow-400 font-black text-9xl animate-ping mb-8">{localCountdown}</div>
                                                <div className="text-white text-2xl font-black tracking-widest bg-yellow-600/20 px-8 py-4 rounded-full border border-yellow-500/30 text-center">æŒ‘æˆ°å³å°‡é–‹å§‹...</div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {gameStep === 'quiz' && (
                                    <div className="flex-grow flex flex-col h-full relative">
                                        <WordCloud words={players} isBackground={true} />
                                        <div className="flex-grow flex flex-col space-y-6 z-10">
                                            <div className="flex justify-between items-center bg-red-800/90 p-3 rounded-xl border border-yellow-600/30 text-xs font-black shrink-0 shadow-lg mt-2">
                                                <span className="text-yellow-400">é¡Œæ¬¡ {currentQuestionIndex + 1} / 10</span>
                                                <span className="bg-yellow-500 text-red-900 px-3 py-0.5 rounded-full shadow-inner font-black">å¾—åˆ†ï¼š{score}</span>
                                            </div>
                                            <div className="quiz-card text-red-900 p-8 rounded-3xl shadow-2xl min-h-[140px] flex items-center justify-center text-center shrink-0 border-b-4 border-gray-300">
                                                <p className="text-2xl font-black italic leading-relaxed">{QUESTIONS[currentQuestionIndex].q}</p>
                                            </div>
                                            <div className="grid grid-cols-1 gap-3 flex-grow overflow-y-auto no-scrollbar pb-2">
                                                {QUESTIONS[currentQuestionIndex].a.map((ans, i) => (
                                                    <button key={i} onClick={() => setSelectedOption(i)} 
                                                        className={`p-5 border-2 rounded-2xl transition-all text-left font-black text-xl flex items-center justify-between shadow-md active:scale-[0.98]
                                                            ${selectedOption === i ? 'bg-yellow-500 text-red-900 border-white ring-4 ring-yellow-400/20' : 'bg-red-800/90 border-yellow-600/30 hover:bg-red-700'}`}>
                                                        <span><span className="mr-4 opacity-50 font-mono">{String.fromCharCode(65 + i)}</span> {ans}</span>
                                                        {selectedOption === i && <Icon name="check-circle-2" className="w-7 h-7 text-red-900 animate-in zoom-in" />}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="h-24 flex items-center pt-2 shrink-0">
                                                {selectedOption !== null && (
                                                    <button onClick={confirmAnswer} className="w-full py-5 bg-yellow-400 text-red-900 font-black rounded-2xl shadow-xl text-2xl border-b-4 border-yellow-600 animate-in slide-in-from-bottom-4">
                                                        ç¢ºèªé€å‡ºç­”æ¡ˆ <Icon name="chevron-right" className="inline w-8 h-8" />
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {gameStep === 'leaderboard' && (
                                    <div className="flex flex-col space-y-4 h-full animate-in slide-in-from-bottom duration-500 z-10">
                                        <h2 className="text-3xl font-black text-yellow-400 text-center drop-shadow-md py-4 tracking-widest">é¦¬å¹´é¢¨é›²æ¦œ</h2>
                                        {me && (
                                            <div className="bg-yellow-500 text-red-900 p-5 rounded-3xl border-4 border-white shadow-xl mb-4 shrink-0 transform scale-105">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-14 h-14 rounded-full bg-red-700 text-white flex items-center justify-center font-black text-2xl border-2 border-white shadow-lg">{myRank}</div>
                                                        <div><div className="font-black text-2xl tracking-tighter">{me.name} <span className="text-[10px] bg-red-700 text-white px-2 py-0.5 rounded-full uppercase ml-1 font-black">You</span></div><div className="text-sm font-bold italic opacity-80">"{me.greeting}"</div></div>
                                                    </div>
                                                    <div className="text-right"><div className="text-3xl font-black">{me.score}</div><div className="text-[10px] font-black opacity-50">Points</div></div>
                                                </div>
                                                <div className="mt-4 pt-3 border-t border-red-700/20 text-center bg-red-700 text-white px-3 py-2 rounded-2xl shadow-inner font-black text-xs leading-tight italic">
                                                    {me.prize ? `ğŸ‰ æ­å–œç²çï¼š${me.prize}` : "å¥½é‹å¥”é¨°ï¼è«‹ç¨å€™ç‰‡åˆ»ï¼Œä¸»æŒäººå°‡ä¾åæ¬¡ç‚ºåˆ—æ¦œè‹±é›„æ’¥å‹•è½‰ç›¤ï¼Œè½‰å‡ºæ‚¨çš„å¹´åº¦å¼·é‹çé …ã€‚"}
                                                </div>
                                            </div>
                                        )}
                                        <div className="flex-grow bg-red-800/40 rounded-3xl p-3 border border-yellow-600/20 space-y-2 overflow-y-auto no-scrollbar shadow-inner text-sm mb-4">
                                            {others.length > 0 ? others.map((p) => {
                                                const r = sortedPlayers.findIndex(x => x.id === p.id) + 1;
                                                return (
                                                    <div key={p.id} className="flex items-center justify-between p-4 rounded-2xl bg-red-900/40 border border-white/5 shadow-sm transition-all active:scale-[0.98]">
                                                        <div className="flex items-center gap-4">
                                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-black text-lg ${r === 1 ? 'bg-yellow-400 text-red-900' : r === 2 ? 'bg-gray-300 text-red-900' : r === 3 ? 'bg-amber-600 text-red-900' : 'bg-red-800 text-white opacity-60'}`}>{r}</div>
                                                            <div><div className="font-bold text-lg opacity-90">{p.name}</div><div className="text-[10px] text-yellow-200/40 italic truncate max-w-[140px]">"{p.greeting}"</div></div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="font-black text-xl text-yellow-400/80">{p.score}</div>
                                                            {p.prize && <div className="text-[9px] bg-green-600 text-white px-2 py-0.5 rounded-full mt-1 font-black animate-pulse shadow-md whitespace-nowrap">ğŸ {p.prize}</div>}
                                                        </div>
                                                    </div>
                                                );
                                            }) : <div className="py-20 text-center opacity-30 italic text-yellow-50">æˆç¸¾åŒæ­¥è¼‰å…¥ä¸­...</div>}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const AdminView = ({ players, appId, gameState, PRIZES, sortedPlayers }) => {
            const [selectedId, setSelectedId] = useState('');
            const [spinning, setSpinning] = useState(false);
            const [rot, setRot] = useState(0);
            const prizesPool = gameState.prizesPool || PRIZES;

            const handleResetGame = async () => {
                if (!window.confirm("ç¢ºå®šè¦é‡è¨­å…¨å ´æ´»å‹•å—ï¼Ÿé€™æœƒåˆªé™¤æ‰€æœ‰ç©å®¶ç´€éŒ„èˆ‡é‡ç½®çé …æ± ã€‚")) return;
                const batch = db.batch();
                players.forEach(p => batch.delete(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players').doc(p.id)));
                batch.set(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('gameState'), { countdownStartTime: 0, prizesPool: INITIAL_PRIZES });
                await batch.commit();
            };

            const startCountdown = async () => await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('gameState').update({ countdownStartTime: Date.now() });
            
            const handleSpin = async () => {
                if(!selectedId || spinning || prizesPool.length === 0) return;
                setSpinning(true);
                const pIdx = Math.floor(Math.random() * prizesPool.length);
                const won = prizesPool[pIdx];
                const segAngle = 360 / prizesPool.length;
                const targetAngle = 360 - (pIdx * segAngle) - (segAngle / 2);
                const newRot = rot + 1800 + targetAngle - (rot % 360);
                setRot(newRot);
                setTimeout(async () => {
                    setSpinning(false);
                    const batch = db.batch();
                    batch.update(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players').doc(selectedId), { prize: won });
                    batch.update(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('gameState'), { prizesPool: prizesPool.filter((_, idx) => idx !== pIdx) });
                    await batch.commit();
                    setSelectedId('');
                }, 3500);
            };

            // SVG è½‰ç›¤æ‰‡å½¢è·¯å¾‘è¨ˆç®—
            const getWedgePath = (index, total) => {
                const angle = 360 / total;
                const startAngle = index * angle;
                const endAngle = (index + 1) * angle;
                const x1 = 150 + 150 * Math.cos((startAngle - 90) * Math.PI / 180);
                const y1 = 150 + 150 * Math.sin((startAngle - 90) * Math.PI / 180);
                const x2 = 150 + 150 * Math.cos((endAngle - 90) * Math.PI / 180);
                const y2 = 150 + 150 * Math.sin((endAngle - 90) * Math.PI / 180);
                return `M 150 150 L ${x1} ${y1} A 150 150 0 0 1 ${x2} ${y2} Z`;
            };

            return (
                <div className="flex flex-col h-full animate-in fade-in no-scrollbar overflow-y-auto pb-32">
                    <div className="bg-yellow-500 p-6 rounded-3xl text-red-900 text-center shadow-xl shrink-0 flex justify-between items-center mb-6">
                        <span className="font-black text-2xl tracking-tighter">iPad æ§ç®¡ä¸­å¿ƒ</span>
                        <button onClick={handleResetGame} className="bg-red-700 text-white px-3 py-1 rounded-xl text-xs font-bold shadow-lg">ğŸ›‘ é‡è¨­å…¨å ´</button>
                    </div>

                    <div className="bg-red-800 p-6 rounded-3xl border-2 border-yellow-600/30 shadow-lg text-center space-y-2 shrink-0 mb-6">
                        <div className="text-3xl font-black text-white">{players.length} / 9 ä½è‹±é›„ç™»éŒ„</div>
                        <button onClick={startCountdown} disabled={gameState.countdownStartTime > 0} className={`w-full py-5 rounded-2xl font-black text-2xl shadow-xl transition-all border-b-4 ${gameState.countdownStartTime > 0 ? 'bg-gray-600' : 'bg-yellow-500 text-red-900 border-yellow-700 active:translate-y-1'}`}>{gameState.countdownStartTime > 0 ? 'âœ… å€’æ•¸è¨Šè™Ÿå·²ç™¼é€' : 'ğŸ”¥ å•Ÿå‹• 5ç§’ çµ±ä¸€å€’æ•¸'}</button>
                    </div>

                    <div className="flex flex-col items-center bg-red-900/40 p-6 rounded-3xl border border-yellow-600/20 shadow-inner shrink-0 mb-6 relative">
                        <div className="relative w-80 h-80 mb-8 shrink-0 flex items-center justify-center">
                            <div className="absolute inset-0 bg-yellow-400/10 rounded-full blur-3xl animate-pulse"></div>
                            {/* --- SVG è½‰ç›¤å¼•æ“ --- */}
                            <svg className="w-full h-full drop-shadow-2xl transition-transform duration-[3500ms] ease-out" style={{ transform: `rotate(${rot}deg)`, width: '300px', height: '300px' }} viewBox="0 0 300 300">
                                {prizesPool.map((p, i) => {
                                    const colors = ['#ef4444', '#b91c1c', '#f59e0b', '#ea580c']; // å››è‰²åˆ‡åˆ†
                                    const angle = 360 / prizesPool.length;
                                    const midAngle = (i * angle) + (angle / 2) - 90;
                                    const textX = 150 + 90 * Math.cos(midAngle * Math.PI / 180);
                                    const textY = 150 + 90 * Math.sin(midAngle * Math.PI / 180);

                                    return (
                                        <g key={i}>
                                            <path d={getWedgePath(i, prizesPool.length)} fill={colors[i % colors.length]} stroke="#fff" strokeWidth="1" />
                                            <text x={textX} y={textY} fill="white" fontSize={prizesPool.length > 6 ? "13" : "16"} fontWeight="900" textAnchor="middle" dominantBaseline="middle" transform={`rotate(${midAngle + 90}, ${textX}, ${textY})`} style={{ textShadow: '1px 1px 2px rgba(0,0,0,0.5)' }}>
                                                {p}
                                            </text>
                                        </g>
                                    );
                                })}
                                {prizesPool.length === 0 && <circle cx="150" cy="150" r="148" fill="#7f1d1d" />}
                            </svg>
                            {/* æŒ‡é‡ */}
                            <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-5 w-12 h-12 bg-yellow-400 z-20 shadow-2xl flex items-center justify-center" style={{ clipPath: 'polygon(50% 100%, 0% 0%, 100% 0%)' }}></div>
                        </div>

                        <div className="w-full space-y-4 px-2 pb-6">
                            <select className="w-full p-4 bg-red-900 border-2 border-yellow-500 rounded-2xl text-lg font-black text-white outline-none shadow-xl appearance-none" value={selectedId} onChange={(e) => setSelectedId(e.target.value)}>
                                <option value="">-- ä¾æ’åé¸æ“‡å¾—çè€… --</option>
                                {sortedPlayers.map((p, i) => <option key={p.id} value={p.id} disabled={!!p.prize} className="text-red-900">#{i+1} {p.name} {p.prize ? `(${p.prize})` : ''}</option>)}
                            </select>
                            <button onClick={handleSpin} disabled={spinning || !selectedId || prizesPool.length === 0} className={`w-full py-6 rounded-2xl font-black text-2xl shadow-xl transition-all border-b-4 ${spinning || !selectedId || prizesPool.length === 0 ? 'bg-gray-600' : 'bg-yellow-500 text-red-900 border-yellow-700 active:translate-y-1'}`}>{spinning ? 'ğŸ å‘½é‹æ—‹è½‰ä¸­...' : prizesPool.length === 0 ? 'çé …å·²å…¨æ•¸æŠ½å®Œ' : 'ğŸ‰ æ’¥å‹•é–‹ç'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>