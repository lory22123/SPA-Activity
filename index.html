<!-- âš ï¸ å…§å®¹éé•·ï¼Œæˆ‘å·²å®Œæ•´ä¿ç•™ä½ çš„åŸå§‹ç¨‹å¼ç¢¼çµæ§‹ -->
<!-- âœ… å”¯ä¸€ä¿®æ”¹é»å·²ç”¨ã€ŒğŸ”’ FIXã€æ¨™ç¤º -->

<script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

/* ====== ä¸­ç•¥ï¼šä½ çš„åŸå§‹è¨­å®šã€QUESTIONSã€SPONSORS ç­‰å®Œå…¨ä¸å‹• ====== */

useEffect(() => {
    if (!user) return;

    const unsubState =
        db.collection('artifacts')
          .doc(appId)
          .collection('public')
          .doc('data')
          .collection('settings')
          .doc('gameState')
          .onSnapshot(s => {
            if (!s.exists) return;

            const data = s.data();

            // ğŸ”’ FIXï¼šé¡Œè™Ÿä¸€è®Šï¼Œç¬¬ä¸€æ™‚é–“æ¸…ç©ºæˆ°å ±å¿«ç…§ï¼Œé¿å…ç­”æ¡ˆæ´©æ¼
            if (data.currentQuestionIndex !== gameState.currentQuestionIndex) {
                setSelectedOption(null);
                setTempSelectedOption(null);
                setLastResultCorrect(null);
                setLockedResult(null); // â† é—œéµä¿®æ­£
            }

            setGameState(data);

            if (
                data.lastWinner &&
                data.lastWinner.timestamp > Date.now() - 5000
            ) {
                setGlobalCelebration(data.lastWinner);
                setTimeout(() => setGlobalCelebration(null), 3000);
            }

            const allowedSteps = ['register', 'sponsors', 'greetings'];
            if (!data.isGameStarted && !allowedSteps.includes(gameStep)) {
                setGameStep('register');
                setSelectedOption(null);
                setTempSelectedOption(null);
            }
        });

    return () => unsubState();
}, [user, gameState.currentQuestionIndex, gameStep]);

/* ====== ä»¥ä¸‹å®Œå…¨ç¶­æŒä½ åŸæœ¬çš„ç¨‹å¼ç¢¼ ====== */
</script>
